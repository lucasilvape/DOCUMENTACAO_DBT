{"config":{"lang":["pt"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"DBT Innoveo Pipeline","text":"<p>Pipeline de dados financeiros da KOVR Seguradora que padroniza e transforma informa\u00e7\u00f5es da plataforma Innoveo em tabelas anal\u00edticas prontas para BI.</p>","tags":["Financeiro"]},{"location":"#visao-geral","title":"Vis\u00e3o Geral","text":"<p>A plataforma Innoveo \u00e9 o sistema de gest\u00e3o de ap\u00f3lices da KOVR. Os dados brutos s\u00e3o extra\u00eddos do banco <code>KOVR_DW</code> (PostgreSQL) e passam por um pipeline dbt estruturado em tr\u00eas camadas antes de chegar \u00e0s ferramentas de BI.</p>","tags":["Financeiro"]},{"location":"#quick-stats","title":"Quick Stats","text":"M\u00e9trica Valor Modelos Staging 44 views Modelos Intermediate 22 ephemeral Modelos Marts 5 (fatos + dimens\u00e3o + views) Modelos DuckDB 3 Sources (grupos) 6 grupos / 38+ tabelas Macros de Neg\u00f3cio 7 Produtos Cobertos 22 seguros Parceiros 9","tags":["Financeiro"]},{"location":"#parceiros-cobertos","title":"Parceiros Cobertos","text":"Parceiro Produtos PicPay Cyber, Phone, Residencial, Auto, Sa\u00fade, Empr\u00e9stimo, Vida Individual, Fatura WillBank Carteira, Celular SemParar Auto, Auto Di\u00e1rio, Viagem, Prestamista KOVR B2C AP, Phone, Vida Disney AP Natura Residencial XP Cart\u00e3o Metlife Celular Banco Fitness Seguro","tags":["Financeiro"]},{"location":"#stack-tecnologica","title":"Stack Tecnol\u00f3gica","text":"Componente Vers\u00e3o <code>dbt-core</code> \u2265 1.10.10 <code>dbt-postgres</code> \u2265 1.9.0 <code>dbt-duckdb</code> \u2265 1.9.6 <code>pandas</code> \u2265 2.3.3 <code>pandera</code> \u2265 0.26.1 <code>python-dotenv</code> \u2265 1.1.1 Python \u2265 3.11 Gerenciador Poetry","tags":["Financeiro"]},{"location":"#navegacao-rapida","title":"Navega\u00e7\u00e3o R\u00e1pida","text":"<ul> <li> <p> Arquitetura</p> <p>Entenda as camadas Staging, Intermediate e Marts e como os dados fluem entre elas.</p> <p> Ver Camadas</p> </li> <li> <p> Linhagem</p> <p>Diagrama visual mostrando a origem e transforma\u00e7\u00e3o de cada tabela.</p> <p> Ver Diagrama</p> </li> <li> <p> Setup para Devs</p> <p>Como configurar e executar o pipeline em Postgres e DuckDB.</p> <p> Ver Setup</p> </li> <li> <p> Macros SQL</p> <p>Refer\u00eancia completa das 7 macros de regras de neg\u00f3cio da Innoveo.</p> <p> Ver Macros</p> </li> <li> <p> Dicion\u00e1rio de Dados</p> <p>Descri\u00e7\u00e3o das colunas das tabelas Marts para usu\u00e1rios de BI.</p> <p> Ver Dicion\u00e1rio</p> </li> <li> <p> KPIs Financeiros</p> <p>Defini\u00e7\u00e3o e f\u00f3rmulas dos indicadores financeiros da Innoveo.</p> <p> Ver KPIs</p> </li> </ul> <p>Documenta\u00e7\u00e3o dbt nativa</p> <p>Este site complementa a documenta\u00e7\u00e3o gerada pelo pr\u00f3prio dbt. Para ver o cat\u00e1logo completo de colunas e linhagem interativa, execute: <pre><code>dbt docs generate\ndbt docs serve\n</code></pre></p>","tags":["Financeiro"]},{"location":"sobre/","title":"Sobre o Projeto","text":"","tags":["Financeiro"]},{"location":"sobre/#o-projeto","title":"O Projeto","text":"<p>O DBT Innoveo Pipeline \u00e9 o pipeline oficial de dados financeiros da KOVR Seguradora. Ele padroniza e transforma os dados brutos da plataforma Innoveo \u2014 sistema de gest\u00e3o de ap\u00f3lices \u2014 em tabelas anal\u00edticas prontas para consumo em ferramentas de BI.</p> <p>O pipeline cobre 22 produtos de seguro distribu\u00eddos por 9 parceiros, processando informa\u00e7\u00f5es de emiss\u00e3o, parcelas, pagamentos, cancelamentos e estornos de forma incremental e audit\u00e1vel.</p>","tags":["Financeiro"]},{"location":"sobre/#equipe-responsavel","title":"Equipe Respons\u00e1vel","text":"<p>Squad: Equipe de Dados BI \u2014 KOVR Seguradora</p> Nome Role Contato Thiago Holanda Ramalho Especialista de Dados Thiago.Ramalho@kovr.com.br Lucas Silva Pereira Desenvolvedor lucas.silva@kev.tech Matheus Araujo Oliveira Analista de Dados S\u00eanior Matheus.Oliveira@kovr.com.br <p>D\u00favidas ou problemas?</p> <p>Entre em contato com um dos membros da equipe abaixo ou utilize os canais oficiais na se\u00e7\u00e3o Contato.</p>","tags":["Financeiro"]},{"location":"sobre/#links-uteis","title":"Links \u00dateis","text":"Link Descri\u00e7\u00e3o  Reposit\u00f3rio GitHub C\u00f3digo fonte do projeto  Documenta\u00e7\u00e3o P\u00e1gina inicial da documenta\u00e7\u00e3o","tags":["Financeiro"]},{"location":"sobre/#licenca","title":"Licen\u00e7a","text":"<p>Uso Interno</p> <p>Este projeto \u00e9 de uso interno exclusivo da Kovr Seguradora.</p> <p>Todos os direitos reservados. O c\u00f3digo e a documenta\u00e7\u00e3o n\u00e3o podem ser distribu\u00eddos, copiados ou utilizados fora do ambiente corporativo da Kovr sem autoriza\u00e7\u00e3o pr\u00e9via.</p>","tags":["Financeiro"]},{"location":"sobre/#contato","title":"Contato","text":"<p>Para d\u00favidas, sugest\u00f5es ou reportar problemas:</p> Canal Informa\u00e7\u00e3o  Email usrpbi@kovr.com.br  Teams Canal \"Equipe de Dados\"","tags":["Financeiro"]},{"location":"architecture/layers/","title":"Camadas de Transforma\u00e7\u00e3o","text":"<p>O pipeline segue a arquitetura Medallion adaptada para o contexto de seguros da Innoveo. Os dados percorrem tr\u00eas camadas progressivas de refinamento antes de chegar \u00e0s tabelas anal\u00edticas.</p> <pre><code>Sources (KOVR_DW.public)\n    \u2514\u2500\u2500 innoveo_*_infos       (dados da ap\u00f3lice)\n    \u2514\u2500\u2500 innoveo_*_parcelas    (dados financeiros)\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   STAGING  (44 views)       \u2502  \u2190 Limpeza, cast, renomea\u00e7\u00e3o\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n              \u2502\n              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  INTERMEDIATE  (22 ephemeral)\u2502  \u2190 Join infos+parcelas, regras de neg\u00f3cio\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n              \u2502\n              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   MARTS  (5 tabelas/views)  \u2502  \u2190 Fatos e dimens\u00f5es para BI\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#1-camada-staging","title":"1. Camada Staging","text":"<p>Schema: <code>staging</code> | Materializa\u00e7\u00e3o: <code>view</code> | Tag: <code>staging</code>, <code>View</code></p>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#papel","title":"Papel","text":"<p>A camada Staging \u00e9 o ponto de entrada dos dados brutos da Innoveo.</p>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#padrao-de-nomenclatura","title":"Padr\u00e3o de Nomenclatura","text":"<p>Cada produto possui dois modelos em staging (exceto produtos que n\u00e3o possuem parcelas):</p> Tipo Padr\u00e3o Conte\u00fado <code>stg_&lt;parceiro&gt;_&lt;produto&gt;_infos</code> <code>stg_picpay_cyber_infos</code> Dados da ap\u00f3lice/bilhete <code>stg_&lt;parceiro&gt;_&lt;produto&gt;_parcelas</code> <code>stg_picpay_cyber_parcelas</code> Dados de cobran\u00e7a/pagamento <p>Por que separar infos e parcelas?</p> <p>A Innoveo armazena dados de ap\u00f3lice e dados financeiros em tabelas distintas. A separa\u00e7\u00e3o em staging respeita essa estrutura e facilita o diagn\u00f3stico de problemas de qualidade em cada fonte independentemente.</p>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#colunas-produzidas-_infos","title":"Colunas Produzidas \u2014 <code>*_infos</code>","text":"Coluna Tipo Descri\u00e7\u00e3o <code>uuid_bilhete</code> <code>TEXT</code> Chave prim\u00e1ria da ap\u00f3lice \u2014 <code>info_uuid</code> normalizado <code>info_quotecounter</code> <code>VARCHAR</code> N\u00famero leg\u00edvel do bilhete na Innoveo <code>info_status</code> <code>VARCHAR</code> Status do bilhete (<code>Ativa</code>, <code>Cancelada</code>, etc.) <code>data_inicio</code> <code>DATE</code> Data de cria\u00e7\u00e3o do bilhete <code>data_inicio_vigencia</code> <code>DATE</code> In\u00edcio da cobertura <code>data_fim_vigencia</code> <code>DATE</code> Fim da cobertura <code>data_cancelamento</code> <code>TIMESTAMP</code> Data de cancelamento <code>data_atualizacao</code> <code>TIMESTAMP</code> \u00daltima modifica\u00e7\u00e3o \u2014 usado no incremental <code>info_productkey</code> <code>TEXT</code> Chave t\u00e9cnica do produto <code>info_fif</code> <code>TEXT</code> Primeira parcela gr\u00e1tis ou n\u00e3o <code>nr_cpf</code> / <code>nome</code> / <code>email</code> <code>TEXT</code> Dados do segurado <p>Campos Infos</p> <p>Os campos acima s\u00e3o apenas exemplos, cada produto tem nas sus infos suas particularidades.</p>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#colunas-produzidas-_parcelas","title":"Colunas Produzidas \u2014 <code>*_parcelas</code>","text":"Coluna Tipo Descri\u00e7\u00e3o <code>uuid_parcela</code> <code>TEXT</code> Chave da parcela <code>uuid_bilhete</code> <code>TEXT</code> FK para a ap\u00f3lice <code>data_vencimento</code> <code>DATE</code> Data de vencimento da cobran\u00e7a <code>data_pagamento</code> <code>DATE</code> Data de pagamento <code>data_estorno</code> <code>DATE</code> Data de estorno <code>data_comp_vencimento</code> <code>BIGINT</code> Compet\u00eancia <code>YYYYMM</code> do vencimento <code>data_comp_pagamento</code> <code>BIGINT</code> Compet\u00eancia <code>YYYYMM</code> do pagamento <code>data_comp_estorno</code> <code>BIGINT</code> Compet\u00eancia <code>YYYYMM</code> do estorno <code>valor_parcela</code> <code>FLOAT</code> Valor em BRL <code>valor_tarifario</code> <code>FLOAT</code> Valor tarif\u00e1rio em BRL <code>status</code> <code>VARCHAR</code> Status da parcela <code>data_atualizacao</code> <code>TIMESTAMP</code> \u00daltima modifica\u00e7\u00e3o <p>LGPD \u2014 Campos sens\u00edveis</p> <p>Os campos <code>nr_cpf</code>, <code>nome</code>, <code>email_segurado</code> e <code>nr_telefone</code> est\u00e3o presentes na staging mas devem ser anonimizados ou omitidos em relat\u00f3rios entregues externamente. Consulte a pol\u00edtica de dados da KOVR antes de expor esses campos.</p>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#2-camada-intermediate","title":"2. Camada Intermediate","text":"<p>Schema: N/A (ephemeral) | Materializa\u00e7\u00e3o: <code>ephemeral</code> | Tag: <code>intermediate</code></p>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#papel_1","title":"Papel","text":"<p>Os modelos intermediate n\u00e3o geram objetos no banco de dados. S\u00e3o compilados como CTEs inline quando referenciados pelos Marts. Aqui acontece toda a l\u00f3gica de neg\u00f3cio:</p> <ol> <li>JOIN entre <code>*_infos</code> e <code>*_parcelas</code> pelo <code>uuid_parcela</code></li> <li>Aplica\u00e7\u00e3o das macros de regras de neg\u00f3cio (normaliza\u00e7\u00e3o de status, c\u00e1lculo de compet\u00eancia, FIF, etc.)</li> <li>Gera\u00e7\u00e3o da chave \u00fanica <code>chave_uuid_parcela</code></li> <li>C\u00e1lculo de <code>cd_evento</code> (c\u00f3digo num\u00e9rico de evento financeiro)</li> <li>Atribui\u00e7\u00e3o de <code>cd_produto</code>, <code>nm_produto</code> e metadados do produto</li> </ol>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#schema-canonico","title":"Schema Can\u00f4nico","text":"<p>Todos os 22 modelos intermediate produzem exatamente o mesmo conjunto de colunas \u2014 isso \u00e9 o que permite o <code>UNION ALL</code> eficiente nos Marts:</p> Coluna Tipo Descri\u00e7\u00e3o <code>chave_uuid_parcela</code> <code>TEXT</code> PK composta: <code>uuid_bilhete_uuid_parcela_nr</code> <code>uuid_bilhete</code> <code>TEXT</code> Chave da ap\u00f3lice <code>uuid_parcela</code> <code>TEXT</code> Chave da parcela <code>transactionid</code> <code>TEXT</code> ID da transa\u00e7\u00e3o de pagamento <code>bilhete</code> <code>TEXT</code> N\u00famero leg\u00edvel do bilhete <code>status_bilhete</code> <code>TEXT</code> Status normalizado (<code>active</code>, <code>cancelled</code>, etc.) <code>cd_evento</code> <code>INTEGER</code> 101 A vencer \u00b7 201 Pago \u00b7 301 Estornado \u00b7 401 Cancelado <code>status_parcela</code> <code>TEXT</code> Nome can\u00f4nico do evento <code>nr_parcela</code> <code>BIGINT</code> N\u00famero sequencial da parcela <code>valor_parcela</code> <code>FLOAT</code> Valor em BRL <code>valor_tarifario</code> <code>FLOAT</code> Valor tarif\u00e1rio em BRL <code>valor_mensal</code> <code>FLOAT</code> Valor mensal <code>valor_estorno</code> <code>FLOAT</code> Valor estornado <code>data_pagamento</code> <code>TIMESTAMPTZ</code> <code>data_vencimento</code> <code>TIMESTAMPTZ</code> <code>data_estorno</code> <code>TIMESTAMPTZ</code> <code>data_comp_vencimento</code> <code>BIGINT</code> Compet\u00eancia <code>YYYYMM</code> <code>data_comp_pagamento</code> <code>BIGINT</code> Compet\u00eancia <code>YYYYMM</code> <code>data_comp_estorno</code> <code>BIGINT</code> Compet\u00eancia <code>YYYYMM</code> <code>cd_produto</code> <code>INTEGER</code> C\u00f3digo num\u00e9rico do produto <code>nm_produto</code> <code>TEXT</code> Nome comercial do produto <code>info_productkey</code> <code>TEXT</code> Chave t\u00e9cnica Innoveo <code>per_comissao</code> <code>FLOAT</code> % de comiss\u00e3o <code>comissao_corretor</code> <code>FLOAT</code> Comiss\u00e3o do corretor em BRL <code>comissao_agencia</code> <code>FLOAT</code> Comiss\u00e3o da ag\u00eancia em BRL <code>fif</code> <code>INTEGER</code> Primeira parcela gr\u00e1tis: <code>0</code> ou <code>1</code> <code>max_data_modificacao</code> <code>TIMESTAMP</code> <code>GREATEST(info_modified, parc_modified)</code> <p>Nunca consulte modelos Intermediate diretamente</p> <p>Como a materializa\u00e7\u00e3o \u00e9 <code>ephemeral</code>, esses modelos n\u00e3o existem como tabelas ou views no banco. Qualquer query contra eles resultar\u00e1 em erro. Consulte sempre os Marts ou as views do schema <code>financeiro</code>.</p>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#macros-aplicadas","title":"Macros Aplicadas","text":"<pre><code>-- Exemplo simplificado de int_picpay_cyber\nselect\n    {{ gerar_chave_unica('i.uuid_bilhete', 'p.uuid_parcela', 'p.nr_parcela') }}\n        as chave_uuid_parcela,\n    {{ ajuste_cd_evento('p.status') }}                    as cd_evento,\n    {{ ajuste_nm_evento('p.status', 'i.info_status') }}   as status_parcela,\n    {{ ajuste_fif('i.info_fif_fifquote') }}               as fif,\n    {{ gerar_data_base('p.data_vencimento') }}            as data_comp_vencimento,\n    {{ max_data_modificacao('i.data_atualizacao', 'p.data_atualizacao') }}\n        as max_data_modificacao,\n    -- ... demais colunas\nfrom stg_picpay_cyber_infos i\nleft join stg_picpay_cyber_parcelas p using (uuid_parcela)\n</code></pre>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#3-camada-marts","title":"3. Camada Marts","text":"<p>Schema: <code>financeiro</code> | Materializa\u00e7\u00e3o: <code>table</code> / <code>incremental</code> | Tag: <code>marts</code></p>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#papel_2","title":"Papel","text":"<p>Os Marts s\u00e3o as tabelas finais consumidas pelo BI. Consolidam todos os parceiros via <code>UNION ALL</code> dos modelos intermediate e aplicam otimiza\u00e7\u00f5es de performance.</p>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#tabelas-disponiveis","title":"Tabelas Dispon\u00edveis","text":"Modelo Tipo Descri\u00e7\u00e3o <code>innoveo_fato_bi</code> <code>table</code> Fato principal \u2014 todos os produtos <code>innoveo_financeiro_demais</code> <code>incremental</code> Todos os produtos, exceto PicPay Cyber \u2014 janela 2 dias <code>innoveo_financeiro_picpay_cyber</code> <code>table</code> Exclusivo PicPay Cyber <code>vw_innoveo_financeiro_demais_resumida</code> <code>view</code> Vers\u00e3o resumida de <code>financeiro_demais</code> <code>vw_innoveo_financeiro_picpay_cyber_resumida</code> <code>view</code> Vers\u00e3o resumida do PicPay Cyber <code>dim_info</code> <code>table</code> Dimens\u00e3o de metadados de produtos <p>Tabelas Incrementais \u2014 Janela Retroativa</p> <p>O modelo <code>innoveo_financeiro_demais</code> usa estrat\u00e9gia incremental com janela retroativa de 2 dias: <pre><code>where max_data_modificacao &gt;= CURRENT_DATE - INTERVAL '2 day'\n</code></pre> Use <code>--full-refresh</code> apenas quando houver mudan\u00e7as estruturais no schema. Em execu\u00e7\u00f5es normais CI/CD, o incremental \u00e9 suficiente e muito mais eficiente.</p>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#otimizacoes-de-performance","title":"Otimiza\u00e7\u00f5es de Performance","text":"<p>Ap\u00f3s cada carga nos Marts, o pipeline executa via <code>post_hook</code>:</p> <pre><code>-- 19 \u00edndices criados automaticamente pela macro create_indexes()\nCREATE INDEX IF NOT EXISTS idx_innoveo_financeiro_demais_uuid_bilhete\n    ON financeiro.innoveo_financeiro_demais (uuid_bilhete);\n-- ... + 18 outros \u00edndices em colunas de filtro e join frequentes\nANALYZE financeiro.innoveo_financeiro_demais;\n</code></pre>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/layers/#fluxo-completo-de-dados","title":"Fluxo Completo de Dados","text":"<pre><code>KOVR_DW.public\n\u251c\u2500\u2500 innoveo_picpay_cyber_infos\n\u2502   \u2514\u2500\u2500 stg_picpay_cyber_infos \u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u251c\u2500\u2500 innoveo_picpay_cyber_parcelas     \u2502\n\u2502   \u2514\u2500\u2500 stg_picpay_cyber_parcelas \u2500\u2500\u2500\u2524\n\u2502                                     \u251c\u2500\u2500\u25ba int_picpay_cyber (ephemeral)\n\u2502                                     \u2502         \u2502\n... (outros 21 produtos) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2502\n                                                 \u25bc\n                                    innoveo_fato_bi (Marts)\n                                    innoveo_financeiro_demais (Marts)\n                                    innoveo_financeiro_picpay_cyber (Marts)\n</code></pre>","tags":["Staging","Intermediate","Marts","Financeiro"]},{"location":"architecture/lineage/","title":"Diagrama de Linhagem","text":"<p>Visualiza\u00e7\u00e3o do fluxo de dados desde as tabelas brutas do <code>KOVR_DW</code> at\u00e9 os Marts anal\u00edticos.</p> <p>Escopo</p> <p>O diagrama abaixo representa a linhagem l\u00f3gica do pipeline. Para a linhagem interativa com colunas e testes, acesse o cat\u00e1logo nativo do dbt com <code>dbt docs serve</code>.</p>","tags":["Staging","Intermediate","Marts"]},{"location":"architecture/lineage/#linhagem-por-parceiro-marts","title":"Linhagem por Parceiro \u2192 Marts","text":"<pre><code>flowchart LR\n    subgraph SRC[\"\ud83d\uddc4\ufe0f Sources \u2014 KOVR_DW\"]\n        direction TB\n        S1[\"innoveo_picpay_*_infos/parcelas\\n(8 produtos)\"]\n        S2[\"innoveo_willbank_*_infos/parcelas\\n(2 produtos)\"]\n        S3[\"innoveo_semparar_*_infos/parcelas\\n(4 produtos)\"]\n        S4[\"innoveo_kovr_*_infos/parcelas\\n(3 produtos)\"]\n        S5[\"innoveo_disney_ap_infos/parcelas\"]\n        S6[\"innoveo_natura_residencial_infos/parcelas\"]\n        S7[\"innoveo_xp_cartao_infos/parcelas\"]\n        S8[\"innoveo_metlife_celular_infos/parcelas\"]\n        S9[\"innoveo_banco_fitness_infos/parcelas\"]\n    end\n\n    subgraph STG[\"\ud83d\udccb Staging (44 views)\"]\n        direction TB\n        ST1[\"stg_picpay_*\"]\n        ST2[\"stg_willbank_*\"]\n        ST3[\"stg_semparar_*\"]\n        ST4[\"stg_kovr_*\"]\n        ST5[\"stg_disney_ap_*\"]\n        ST6[\"stg_natura_residencial_*\"]\n        ST7[\"stg_xp_card_*\"]\n        ST8[\"stg_metlife_celular_*\"]\n        ST9[\"stg_banco_fitness_*\"]\n    end\n\n    subgraph INT[\"\u2699\ufe0f Intermediate (22 ephemeral)\"]\n        direction TB\n        I1A[\"int_picpay_cyber\"]\n        I1B[\"int_picpay_auto\\nint_picpay_phone\"]\n        I1C[\"int_picpay_residencial\\nint_picpay_saude\\nint_picpay_emprestimo\\nint_picpay_vida_individual\\nint_picpay_fatura\"]\n        I2[\"int_willbank_carteira\\nint_willbank_celular\"]\n        I3[\"int_semparar_auto\\nint_semparar_autodiario\\nint_semparar_viagem\\nint_semparar_prestamista\"]\n        I4[\"int_kovr_ap\\nint_kovr_phone\\nint_kovr_vida\\nint_disney_ap\"]\n        I5[\"int_natura_residencial\\nint_xp_card\\nint_metlife_celular\\nint_banco_fitness\"]\n    end\n\n    subgraph MARTS[\"\ud83d\udcca Marts \u2014 schema: financeiro\"]\n        direction TB\n        M1[\"innoveo_fato_bi\\n(table \u2014 todos os produtos)\"]\n        M2[\"innoveo_financeiro_demais\\n(incremental \u2014 exceto PicPay Cyber)\"]\n        M3[\"innoveo_financeiro_picpay_cyber\\n(table)\"]\n        V1[\"vw_innoveo_financeiro_demais_resumida\"]\n        V2[\"vw_innoveo_financeiro_picpay_cyber_resumida\"]\n    end\n\n    S1 --&gt; ST1 --&gt; I1A\n    S1 --&gt; ST1 --&gt; I1B\n    S1 --&gt; ST1 --&gt; I1C\n    S2 --&gt; ST2 --&gt; I2\n    S3 --&gt; ST3 --&gt; I3\n    S4 --&gt; ST4 --&gt; I4\n    S5 --&gt; ST5 --&gt; I4\n    S6 --&gt; ST6 --&gt; I5\n    S7 --&gt; ST7 --&gt; I5\n    S8 --&gt; ST8 --&gt; I5\n    S9 --&gt; ST9 --&gt; I5\n\n    I1A --&gt; M3\n    I1B --&gt; M1\n    I1B --&gt; M2\n    I1C --&gt; M2\n    I2 --&gt; M2\n    I3 --&gt; M2\n    I4 --&gt; M2\n    I5 --&gt; M2\n\n    M2 --&gt; V1\n    M3 --&gt; V2</code></pre>","tags":["Staging","Intermediate","Marts"]},{"location":"architecture/lineage/#linhagem-detalhada-picpay-cyber","title":"Linhagem Detalhada \u2014 PicPay Cyber","text":"<pre><code>flowchart LR\n    src1[\"innoveo_picpay_cyber_infos\\n(KOVR_DW.public)\"]\n    src2[\"innoveo_picpay_cyber_parcelas\\n(KOVR_DW.public)\"]\n\n    stg1[\"stg_picpay_cyber_infos\\n(view \u00b7 schema: staging)\"]\n    stg2[\"stg_picpay_cyber_parcelas\\n(view \u00b7 schema: staging)\"]\n\n    int1[\"int_picpay_cyber\\n(ephemeral)\"]\n\n    mart1[\"innoveo_fato_bi\\n(table \u00b7 schema: financeiro)\"]\n    mart2[\"innoveo_financeiro_picpay_cyber\\n(table \u00b7 schema: financeiro)\"]\n    view1[\"vw_innoveo_financeiro_picpay_cyber_resumida\\n(view \u00b7 schema: financeiro)\"]\n\n    src1 --&gt; stg1\n    src2 --&gt; stg2\n    stg1 --&gt; int1\n    stg2 --&gt; int1\n    int1 --&gt; mart1\n    int1 --&gt; mart2\n    mart2 --&gt; view1</code></pre>","tags":["Staging","Intermediate","Marts"]},{"location":"architecture/lineage/#linhagem-das-macros-de-negocio","title":"Linhagem das Macros de Neg\u00f3cio","text":"<pre><code>flowchart TD\n    subgraph MACROS[\"\ud83d\udd27 Macros \u2014 regras_negocio_innoveo\"]\n        M1[\"ajuste_cd_evento()\\n101 / 201 / 301 / 401\"]\n        M2[\"ajuste_nm_evento()\\nnormaliza\u00e7\u00e3o de texto\"]\n        M3[\"ajuste_fif()\\n0 ou 1\"]\n        M4[\"gerar_chave_unica()\\nuuid_bilhete_uuid_parcela_nr\"]\n        M5[\"gerar_data_base()\\nYYYYMM INTEGER\"]\n        M6[\"max_data_modificacao()\\nGREATEST(info, parc)\"]\n        M7[\"create_indexes()\\npost_hook DDL\"]\n    end\n\n    INT[\"int_* (22 modelos)\"]\n    MARTS[\"Marts (5 tabelas/views)\"]\n\n    M1 --&gt; INT\n    M2 --&gt; INT\n    M3 --&gt; INT\n    M4 --&gt; INT\n    M5 --&gt; INT\n    M6 --&gt; INT\n    INT --&gt; MARTS\n    M7 --&gt; MARTS</code></pre>","tags":["Staging","Intermediate","Marts"]},{"location":"architecture/lineage/#targets-e-destinos","title":"Targets e Destinos","text":"<pre><code>flowchart LR\n    subgraph PG[\"\ud83d\udc18 PostgreSQL \u2014 target: prod\"]\n        PG1[\"KOVR_DW.public\\n(Sources)\"]\n        PG2[\"KOVR_DW.staging\\n(44 views)\"]\n        PG3[\"KOVR_DW.financeiro\\n(5 Marts)\"]\n        PG1 --&gt; PG2 --&gt; PG3\n    end\n\n    subgraph DUCK[\"\ud83e\udd86 DuckDB \u2014 target: duckdb_prod\"]\n        D1[\"warehouse.duckdb\\n(arquivo local)\"]\n        D2[\"duckdb_demais_produtos\\nduckdb_picpay_cyber\"]\n        D1 --&gt; D2\n    end\n\n    subgraph PY[\"\ud83d\udc0d Pipelines Python\"]\n        P1[\"pipeline_innoveo_demais_produtos.py\"]\n        P2[\"pipeline_innoveo_picpay_cyber.py\"]\n        P3[\"pipeline_duckdb_*.py\"]\n    end\n\n    PG3 --&gt; P1\n    PG3 --&gt; P2\n    P1 --&gt; DUCK\n    P2 --&gt; DUCK\n    P3 --&gt; DUCK</code></pre>","tags":["Staging","Intermediate","Marts"]},{"location":"development/macros/","title":"Refer\u00eancia de Macros SQL","text":"<p>O projeto define 7 macros de regras de neg\u00f3cio em <code>macros/regras_negocio_innoveo/</code> e 4 macros auxiliares em <code>macros/macros_duckdb/</code>. Todas s\u00e3o escritas em Jinja2/SQL no padr\u00e3o dbt.</p>","tags":["Financeiro","Staging","Intermediate"]},{"location":"development/macros/#macros-de-regras-de-negocio","title":"Macros de Regras de Neg\u00f3cio","text":"","tags":["Financeiro","Staging","Intermediate"]},{"location":"development/macros/#ajuste_cd_eventocoluna","title":"<code>ajuste_cd_evento(coluna)</code>","text":"<p>Converte o status textual bruto de uma parcela em um c\u00f3digo num\u00e9rico padronizado de evento financeiro.</p> <p>Arquivo: <code>macros/regras_negocio_innoveo/ajuste_cd_evento.sql</code></p> <p>Tabela de mapeamento:</p> Status bruto (Innoveo) <code>cd_evento</code> Significado <code>parcela a vencer</code> 101 A vencer <code>a vencer</code> 101 A vencer <code>parcela paga</code> 201 Pago <code>pago</code> 201 Pago <code>parcela gr\u00e1tis</code> / <code>parcela gratis</code> 201 Pago (sem custo) <code>parcela estornada</code> 301 Estornado <code>parcela cancelada</code> 401 Cancelado <code>parcela cancelada por lmi</code> 401 Cancelado <code>n\u00e3o paga</code> 401 Cancelado / n\u00e3o cobrado <code>cancelada</code> 401 Cancelado Outros / NULL <code>NULL</code> N\u00e3o mapeado <p>SQL gerado:</p> <pre><code>case lower(status_parcela)\n    when 'parcela a vencer'          then 101\n    when 'a vencer'                  then 101\n    when 'parcela paga'              then 201\n    when 'pago'                      then 201\n    when 'parcela gr\u00e1tis'            then 201\n    when 'parcela gratis'            then 201\n    when 'parcela estornada'         then 301\n    when 'parcela cancelada'         then 401\n    when 'parcela cancelada por lmi' then 401\n    when 'n\u00e3o paga'                  then 401\n    when 'cancelada'                 then 401\n    else null\nend\n</code></pre> <p>Uso:</p> <pre><code>{{ ajuste_cd_evento('p.status') }} as cd_evento\n</code></pre>","tags":["Financeiro","Staging","Intermediate"]},{"location":"development/macros/#ajuste_nm_eventocoluna-status_bilhetenone","title":"<code>ajuste_nm_evento(coluna, status_bilhete=None)</code>","text":"<p>Normaliza textos livres de status de parcela para valores can\u00f4nicos consistentes em todo o pipeline.</p> <p>Arquivo: <code>macros/regras_negocio_innoveo/ajuste_nm_evento.sql</code></p> <p>Mapeamento de normaliza\u00e7\u00e3o:</p> Entrada (bruta) Sa\u00edda (can\u00f4nica) <code>'n\u00e3o paga'</code> <code>'parcela a vencer'</code> <code>'pago'</code> <code>'parcela paga'</code> <code>like 'gr%'</code> (gr\u00e1tis, gratis) <code>'parcela gr\u00e1tis'</code> <code>'a vencer'</code> <code>'parcela a vencer'</code> <code>'cancelada'</code> (com bilhete cancelado) <code>'parcela cancelada'</code> <code>NULL</code> ou <code>'0'</code> (com bilhete cancelado) <code>'parcela cancelada'</code> <p>Par\u00e2metro <code>status_bilhete</code> \u2014 caso especial</p> <p>Quando o <code>status_bilhete</code> \u00e9 <code>'cancelled'</code> e o status da parcela \u00e9 <code>NULL</code> ou <code>'0'</code>, a macro infere que a parcela deve ser marcada como <code>'parcela cancelada'</code>. Esse caso ocorre em produtos onde o cancelamento do bilhete n\u00e3o propaga o status para as parcelas na Innoveo.</p> <pre><code>-- Com status_bilhete como contexto adicional\n{{ ajuste_nm_evento('p.status', 'i.info_status') }} as status_parcela\n</code></pre> <p>Uso:</p> <pre><code>-- Sem contexto de bilhete\n{{ ajuste_nm_evento('p.status') }} as status_parcela\n\n-- Com contexto de bilhete (recomendado)\n{{ ajuste_nm_evento('p.status', 'i.info_status') }} as status_parcela\n</code></pre>","tags":["Financeiro","Staging","Intermediate"]},{"location":"development/macros/#ajuste_fifvalor","title":"<code>ajuste_fif(valor)</code>","text":"<p>Padroniza o indicador FIF (Parcela Gr\u00e1tis) para um flag bin\u00e1rio <code>INTEGER</code>.</p> <p>Arquivo: <code>macros/regras_negocio_innoveo/ajuste_fif.sql</code></p> Entrada Sa\u00edda <code>NULL</code>, <code>'false'</code>, <code>'nan'</code>, <code>'n'</code>, <code>'no'</code> 0 <code>'sim'</code>, <code>'true'</code>, <code>'s'</code>, <code>'yes'</code> 1 Qualquer outro valor 0 (default) <p>O que \u00e9 FIF?</p> <p>FIF indica que possui parcela gr\u00e1tis \u2014 ou seja, n\u00e3o h\u00e1 cobran\u00e7a financeira ao cliente..</p> <p>Uso:</p> <pre><code>{{ ajuste_fif('i.info_fif_fifquote') }} as fif\n</code></pre>","tags":["Financeiro","Staging","Intermediate"]},{"location":"development/macros/#gerar_chave_unicauuid_bilhete-uuid_parcela-parcela_col","title":"<code>gerar_chave_unica(uuid_bilhete, uuid_parcela, parcela_col)</code>","text":"<p>Gera a chave prim\u00e1ria composta das tabelas Marts, que combina os tr\u00eas identificadores de uma linha financeira.</p> <p>Arquivo: <code>macros/regras_negocio_innoveo/gerar_chave_unica.sql</code></p> <p>SQL gerado:</p> <pre><code>concat(\n    coalesce(uuid_bilhete, ''), '_',\n    coalesce(uuid_parcela, ''), '_',\n    coalesce(nr_parcela::text, '')\n)\n-- Exemplo de valor: 'a1b2c3d4-..._e5f6g7h8-..._1'\n</code></pre> <p>Chave \u00fanica nos Marts</p> <p>A <code>chave_uuid_parcela</code> \u00e9 a <code>unique_key</code> usada na estrat\u00e9gia incremental de <code>innoveo_financeiro_demais</code>. Nunca remova ou altere a l\u00f3gica desta macro sem avaliar o impacto nos \u00edndices e na estrat\u00e9gia de upsert.</p> <p>Uso:</p> <pre><code>{{ gerar_chave_unica('i.uuid_bilhete', 'p.uuid_parcela', 'p.nr_parcela') }}\n    as chave_uuid_parcela\n</code></pre>","tags":["Financeiro","Staging","Intermediate"]},{"location":"development/macros/#gerar_data_basedata_tabela","title":"<code>gerar_data_base(data_tabela)</code>","text":"<p>Converte uma data em um inteiro de compet\u00eancia no formato <code>YYYYMM</code>, usado para agrega\u00e7\u00f5es mensais em BI.</p> <p>Arquivo: <code>macros/regras_negocio_innoveo/gerar_data_base.sql</code></p> <p>SQL gerado:</p> <pre><code>case\n    when data_tabela is not null\n    then cast(to_char(data_tabela, 'YYYYMM') as integer)\n    else null\nend\n-- Exemplo: DATE '2025-03-15' \u2192 202503\n</code></pre> <p>Uso:</p> <pre><code>{{ gerar_data_base('p.data_vencimento') }}  as data_comp_vencimento,\n{{ gerar_data_base('p.data_pagamento') }}   as data_comp_pagamento,\n{{ gerar_data_base('p.data_estorno') }}     as data_comp_estorno\n</code></pre>","tags":["Financeiro","Staging","Intermediate"]},{"location":"development/macros/#max_data_modificacaoinfo_modified-parc_modified","title":"<code>max_data_modificacao(info_modified, parc_modified)</code>","text":"<p>Retorna a data de modifica\u00e7\u00e3o mais recente entre infos e parcelas, usada como crit\u00e9rio de incrementalidade.</p> <p>Arquivo: <code>macros/regras_negocio_innoveo/max_data_modificacao.sql</code></p> <p>SQL gerado:</p> <pre><code>greatest(\n    coalesce(info_modified::TIMESTAMP, '2000-01-01'::TIMESTAMP),\n    coalesce(parc_modified::TIMESTAMP, '2000-01-01'::TIMESTAMP)\n)\n</code></pre> <p>Por que <code>'2000-01-01'</code> como fallback?</p> <p>O <code>coalesce</code> com <code>'2000-01-01'</code> garante que registros com <code>modified</code> nulo ainda sejam compar\u00e1veis, sem propagar NULL para o <code>GREATEST</code>. Isso evita que registros antigos sejam erroneamente ignorados pela janela incremental.</p> <p>Uso:</p> <pre><code>{{ max_data_modificacao('i.data_atualizacao', 'p.data_atualizacao') }}\n    as max_data_modificacao\n</code></pre>","tags":["Financeiro","Staging","Intermediate"]},{"location":"development/macros/#create_indexestable-columns","title":"<code>create_indexes(table, columns=[])</code>","text":"<p>Gera e executa DDL de <code>CREATE INDEX IF NOT EXISTS</code> para cada coluna especificada, seguido de <code>ANALYZE</code>.</p> <p>Arquivo: <code>macros/regras_negocio_innoveo/create_indexes.sql</code></p> <p>SQL gerado (por coluna):</p> <pre><code>CREATE INDEX IF NOT EXISTS idx_innoveo_financeiro_demais_uuid_bilhete\n    ON financeiro.innoveo_financeiro_demais (uuid_bilhete);\n\nANALYZE financeiro.innoveo_financeiro_demais;\n</code></pre> <p>Uso (via <code>post_hook</code> nos Marts):</p> <pre><code>{{ config(\n    post_hook=[\n        \"{{ create_indexes(this, ['uuid_bilhete', 'cd_evento', 'data_comp_vencimento', ...]) }}\"\n    ]\n) }}\n</code></pre> <p>19 \u00edndices no <code>innoveo_financeiro_demais</code></p> <p>O modelo <code>innoveo_financeiro_demais</code> cria 19 \u00edndices automaticamente via <code>post_hook</code>, cobrindo as colunas de filtragem e join mais frequentes no BI: <code>uuid_bilhete</code>, <code>cd_evento</code>, <code>data_comp_vencimento</code>, <code>data_comp_pagamento</code>, <code>nm_produto</code>, <code>status_bilhete</code>, entre outros.</p>","tags":["Financeiro","Staging","Intermediate"]},{"location":"development/macros/#macros-auxiliares-duckdb","title":"Macros Auxiliares (DuckDB)","text":"<p>Localizadas em <code>macros/macros_duckdb/</code>:</p> Macro Prop\u00f3sito <code>importar_tabela_duckdb()</code> Importa tabelas do Postgres para o DuckDB via <code>httpfs</code> <code>pg_conn()</code> Gera string de conex\u00e3o parametrizada ao KOVR_DW <code>etl_duck_agrupamento_emissao()</code> Agrega dados de emiss\u00e3o no DuckDB <code>etl_innoveo_fato_bi_cancelamento()</code> L\u00f3gica de cancelamento espec\u00edfica para o DuckDB","tags":["Financeiro","Staging","Intermediate"]},{"location":"development/macros/#macro-utilitaria","title":"Macro Utilit\u00e1ria","text":"","tags":["Financeiro","Staging","Intermediate"]},{"location":"development/macros/#schema_name-macrosschema_namesql","title":"<code>schema_name</code> (<code>macros/schema_name.sql</code>)","text":"<p>Override do <code>generate_schema_name</code> padr\u00e3o do dbt. Garante que os schemas <code>staging</code>, <code>financeiro</code> e <code>seeds</code> sejam nomeados corretamente independente do target (<code>prod</code> ou <code>dev</code>):</p> <pre><code>-- Em prod: usa o schema definido no config do modelo\n-- Em dev:  prefixa com o schema do perfil (ex: public_dbt_staging)\n{% macro generate_schema_name(custom_schema_name, node) %}\n    ...\n{% endmacro %}\n</code></pre>","tags":["Financeiro","Staging","Intermediate"]},{"location":"development/setup/","title":"Setup e Execu\u00e7\u00e3o","text":"<p>Guia t\u00e9cnico completo para configurar e executar o pipeline <code>dbt_innoveo_pipeline</code> localmente.</p>","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#pre-requisitos","title":"Pr\u00e9-requisitos","text":"Requisito Vers\u00e3o m\u00ednima Notas Python \u2265 3.11 Recomendado via <code>pyenv</code> ou instalador oficial Poetry \u2265 1.7 Gerenciador de depend\u00eancias Acesso ao banco <code>KOVR_DW</code> Solicitar credenciais ao time de de Dados Git qualquer Para clonar o reposit\u00f3rio","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#1-instalacao","title":"1. Instala\u00e7\u00e3o","text":"<pre><code># Clonar o reposit\u00f3rio\ngit clone https://github.com/KovrSeguradoraBI/DBT_KOVR_INNOVEO.git\ncd DBT_KOVR_INNOVEO\n\n# Instalar depend\u00eancias com Poetry\npoetry install\n\n# Ativar o ambiente virtual\npoetry shell\n</code></pre> <p>Sem Poetry?</p> <p>Caso prefira <code>pip</code>: <pre><code>pip install -r requirements.txt\n# ou\npip install dbt-core dbt-postgres dbt-duckdb pandas pandera python-dotenv tqdm\n</code></pre></p>","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#2-configuracao-de-credenciais","title":"2. Configura\u00e7\u00e3o de Credenciais","text":"","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#variaveis-de-ambiente","title":"Vari\u00e1veis de Ambiente","text":"<p>Crie um arquivo <code>.env</code> na raiz do projeto (nunca commite este arquivo):</p> <pre><code># PostgreSQL \u2014 KOVR_DW\nPG_HOST=XXXXXXXXXXXX\nPG_PORT=5432\nPG_DBNAME=xxxxxxxxx\nPG_USER=seu_usuario\nPG_PASSWORD=sua_senha\n</code></pre> <p>Nunca commite senhas</p> <p>O arquivo <code>.env</code> j\u00e1 est\u00e1 no <code>.gitignore</code>. Jamais substitua vari\u00e1veis de ambiente por valores hardcoded no <code>profiles.yml</code>.</p>","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#configurar-profilesyml","title":"Configurar <code>profiles.yml</code>","text":"<p>Copie o arquivo de exemplo e ajuste:</p> <pre><code>cp profiles_exemplo.yml profiles.yml\n</code></pre> PostgreSQLDuckDB <pre><code>dbt_innoveo_pipeline:\n  outputs:\n    prod:\n      type: postgres\n      host: \"{{ env_var('PG_HOST') }}\"\n      user: \"{{ env_var('PG_USER') }}\"\n      password: \"{{ env_var('PG_PASSWORD') }}\"\n      port: \"{{ env_var('PG_PORT') | int }}\"\n      dbname: \"{{ env_var('PG_DBNAME') }}\"\n      schema: public\n      threads: 8\n  target: prod\n</code></pre> <pre><code>dbt_innoveo_pipeline:\n  outputs:\n    duckdb_prod:\n      type: duckdb\n      path: \"{{ env_var('PATH_DUCK') }}\"  # ex: E:/dbt_kovr_innoveo/data/warehouse.duckdb\n      threads: 8\n  target: duckdb_prod\n</code></pre>","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#3-verificar-conexao","title":"3. Verificar Conex\u00e3o","text":"<pre><code>dbt debug\n</code></pre> <p>Sa\u00edda esperada: <pre><code>Connection test: OK connection ok\n</code></pre></p>","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#4-execucao-completa-do-pipeline","title":"4. Execu\u00e7\u00e3o Completa do Pipeline","text":"","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#41-carregar-seeds","title":"4.1 Carregar Seeds","text":"<p>Os seeds cont\u00eam tabelas de refer\u00eancia (ex: <code>planos_tratados.csv</code>). Execute sempre antes do primeiro <code>dbt run</code>:</p> <pre><code>dbt seed\n</code></pre> PostgreSQLDuckDB <pre><code># Carrega no schema: seeds (KOVR_DW)\ndbt seed --target prod\n</code></pre> <pre><code># Carrega no DuckDB local\ndbt seed --target duckdb_prod\n</code></pre>","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#42-executar-modelos","title":"4.2 Executar Modelos","text":"PostgreSQLDuckDB <pre><code># Executar todos os modelos\ndbt run --target prod\n\n# Executar apenas staging\ndbt run --select staging --target prod\n\n# Executar apenas um produto espec\u00edfico\ndbt run --select stg_picpay_cyber_infos+ --target prod\n\n# Full refresh (recria tabelas incrementais do zero)\ndbt run --target prod --full-refresh\n</code></pre> <pre><code># Executar modelos DuckDB\ndbt run --target duckdb_prod\n\n# Modelos espec\u00edficos DuckDB\ndbt run --select duckdb_demais_produtos --target duckdb_prod\n\n# Com full refresh\ndbt run --target duckdb_prod --full-refresh\n</code></pre>","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#43-executar-testes","title":"4.3 Executar Testes","text":"<pre><code># Rodar todos os testes de qualidade\ndbt test\n\n# Testes de uma camada espec\u00edfica\ndbt test --select staging\ndbt test --select marts\n</code></pre>","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#44-gerar-e-servir-documentacao-dbt","title":"4.4 Gerar e Servir Documenta\u00e7\u00e3o dbt","text":"<pre><code>dbt docs generate\ndbt docs serve\n# Acesse http://localhost:8080\n</code></pre>","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#5-seletores-uteis","title":"5. Seletores \u00dateis","text":"Comando O que executa <code>dbt run --select staging</code> Todas as 44 views de staging <code>dbt run --select intermediate</code> Todos os 22 modelos ephemeral <code>dbt run --select marts</code> As 5 tabelas/views de Marts <code>dbt run --select tag:picpay</code> Todos os modelos com tag <code>picpay</code> <code>dbt run --select +innoveo_fato_bi</code> <code>innoveo_fato_bi</code> e todos os seus predecessores <code>dbt run --select innoveo_fato_bi+</code> <code>innoveo_fato_bi</code> e todos os seus sucessores <p>Seletor de upstream</p> <p>O <code>+</code> antes de um modelo seleciona todos os modelos que alimentam aquele modelo. \u00datil para debugar um problema na linhagem: <pre><code>dbt run --select +innoveo_financeiro_demais\n</code></pre></p>","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#6-pipelines-python","title":"6. Pipelines Python","text":"<p>Os pipelines Python em <code>00_FLUXOS_PYTHON/</code> s\u00e3o executados ap\u00f3s o <code>dbt run</code> e movem dados para o DuckDB:</p> Demais ProdutosPicPay CyberDuckDB (Views) <pre><code>python 00_FLUXOS_PYTHON/pipeline_innoveo_demais_produtos.py\n</code></pre> <pre><code>python 00_FLUXOS_PYTHON/pipeline_innoveo_picpay_cyber.py\n</code></pre> <pre><code>python 00_FLUXOS_PYTHON/pipeline_duckdb_views.py\n</code></pre>","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#7-cicd-jenkins","title":"7. CI/CD \u2014 Jenkins","text":"<p>Os Jenkinsfiles em <code>00_FLUXOS_PYTHON/</code> automatizam a execu\u00e7\u00e3o:</p> Arquivo Prop\u00f3sito <code>Jenkinsfile</code> Pipeline principal (dbt + Python) <code>Jenkinsfile_duck</code> Pipeline exclusivo DuckDB <code>Jenkinsfile_financeiro</code> Pipeline financeiro espec\u00edfico <p>Vari\u00e1veis de ambiente no Jenkins</p> <p>As vari\u00e1veis <code>PG_*</code> e <code>PATH_DUCK</code> s\u00e3o injetadas via Jenkins Credentials no ambiente de CI. N\u00e3o h\u00e1 arquivos <code>.env</code> nos servidores.</p>","tags":["Financeiro","DuckDB"]},{"location":"development/setup/#8-troubleshooting","title":"8. Troubleshooting","text":"Erro Causa prov\u00e1vel Solu\u00e7\u00e3o <code>relation does not exist</code> Seeds n\u00e3o carregados Executar <code>dbt seed</code> antes de <code>dbt run</code> <code>Schema \"staging\" does not exist</code> Primeira execu\u00e7\u00e3o dbt cria o schema automaticamente no primeiro run <code>DuckDB: file is not a database</code> PATH_DUCK incorreto Verificar vari\u00e1vel de ambiente <code>PATH_DUCK</code> <code>Compilation Error: ephemeral</code> Query direta em intermediate Intermediate \u00e9 ephemeral \u2014 consulte via Marts","tags":["Financeiro","DuckDB"]},{"location":"marts/dictionary/","title":"Dicion\u00e1rio de Dados \u2014 Marts","text":"<p>Documenta\u00e7\u00e3o das tabelas anal\u00edticas do schema <code>financeiro</code> para uso em BI. Cada coluna est\u00e1 descrita em linguagem de neg\u00f3cio para facilitar a cria\u00e7\u00e3o de relat\u00f3rios.</p> <p>Como usar este dicion\u00e1rio?</p> <p>Este dicion\u00e1rio descreve as tabelas prontas para consumo \u2014 as mesmas que alimentam os dashboards. Para entender transforma\u00e7\u00f5es t\u00e9cnicas, consulte a Refer\u00eancia de Macros.</p>","tags":["Marts","Dicion\u00e1rioDeDados","Financeiro","LGPD"]},{"location":"marts/dictionary/#tabelas-disponiveis","title":"Tabelas Dispon\u00edveis","text":"Tabela Tipo Descri\u00e7\u00e3o Granularidade <code>innoveo_fato_bi</code> <code>table</code> Fato principal com todos os produtos 1 linha por parcela <code>innoveo_financeiro_demais</code> <code>table</code> incremental Todos os produtos exceto PicPay Cyber 1 linha por parcela <code>innoveo_financeiro_picpay_cyber</code> <code>table</code> Exclusivo PicPay Cyber 1 linha por parcela","tags":["Marts","Dicion\u00e1rioDeDados","Financeiro","LGPD"]},{"location":"marts/dictionary/#innoveo_fato_bi-innoveo_financeiro_demais","title":"<code>innoveo_fato_bi</code> / <code>innoveo_financeiro_demais</code>","text":"<p>As tabelas <code>innoveo_fato_bi</code> e <code>innoveo_financeiro_demais</code> possuem o mesmo schema. Cada linha representa uma parcela de um bilhete em um determinado status de evento financeiro.</p>","tags":["Marts","Dicion\u00e1rioDeDados","Financeiro","LGPD"]},{"location":"marts/dictionary/#chaves-e-identificadores","title":"Chaves e Identificadores","text":"Coluna Tipo Descri\u00e7\u00e3o Exemplo <code>chave_uuid_parcela</code> <code>TEXT</code> Chave prim\u00e1ria \u00fanica da linha. Composi\u00e7\u00e3o de UUID do bilhete + UUID da parcela + n\u00famero da parcela <code>a1b2c3_e5f6g7_1</code> <code>uuid_bilhete</code> <code>UUID</code> Identificador t\u00e9cnico \u00fanico da ap\u00f3lice na Innoveo <code>a1b2c3d4-...</code> <code>uuid_parcela</code> <code>UUID</code> Identificador t\u00e9cnico \u00fanico da parcela <code>e5f6g7h8-...</code> <code>bilhete</code> <code>VARCHAR</code> N\u00famero de bilhete leg\u00edvel para o usu\u00e1rio <code>PPC-00123456</code> <code>transactionid</code> <code>TEXT</code> ID da transa\u00e7\u00e3o de pagamento no gateway financeiro <code>TXN_987654</code>","tags":["Marts","Dicion\u00e1rioDeDados","Financeiro","LGPD"]},{"location":"marts/dictionary/#status-e-evento","title":"Status e Evento","text":"<p>Gloss\u00e1rio <code>cd_evento</code></p> <p>O <code>cd_evento</code> \u00e9 o indicador central para an\u00e1lises financeiras. Use-o para filtrar e agrupar corretamente:</p> <code>cd_evento</code> <code>status_parcela</code> Significado de Neg\u00f3cio 101 <code>parcela a vencer</code> Parcela emitida, ainda n\u00e3o cobrada 201 <code>parcela paga</code> Parcela paga com sucesso 201 <code>parcela gr\u00e1tis</code> Sem fluxo financeiro 301 <code>parcela estornada</code> Pagamento devolvido ao cliente 401 <code>parcela cancelada</code> Parcela cancelada Coluna Tipo Descri\u00e7\u00e3o Exemplo <code>cd_evento</code> <code>INTEGER</code> C\u00f3digo num\u00e9rico do evento financeiro (ver gloss\u00e1rio acima) <code>201</code> <code>status_parcela</code> <code>TEXT</code> Descri\u00e7\u00e3o do status da parcela <code>parcela paga</code> <code>status_bilhete</code> <code>VARCHAR</code> Status atual da ap\u00f3lice <code>Ativa</code> / <code>Cancelada</code> <code>nr_parcela</code> <code>BIGINT</code> N\u00famero sequencial da parcela (1, 2, 3...) <code>3</code>","tags":["Marts","Dicion\u00e1rioDeDados","Financeiro","LGPD"]},{"location":"marts/dictionary/#datas","title":"Datas","text":"Coluna Tipo Descri\u00e7\u00e3o Observa\u00e7\u00e3o <code>data_inicio</code> <code>DATE</code> Data de cria\u00e7\u00e3o/emiss\u00e3o do bilhete <code>data_inicio_vigencia</code> <code>DATE</code> In\u00edcio da cobertura do seguro <code>data_fim_vigencia</code> <code>DATE</code> Fim da cobertura do seguro <code>data_cancelamento</code> <code>DATE</code> Data do cancelamento do bilhete Nulo se ativo <code>data_vencimento</code> <code>DATE</code> Data de vencimento da parcela <code>data_pagamento</code> <code>DATE</code> Data de pagamento efetivo Nulo se n\u00e3o pago <code>data_estorno</code> <code>DATE</code> Data do estorno Nulo se n\u00e3o estornado <code>data_comp_vencimento</code> <code>BIGINT</code> Compet\u00eancia de vencimento no formato <code>YYYYMM</code> <code>202503</code> <code>data_comp_pagamento</code> <code>BIGINT</code> Compet\u00eancia de pagamento no formato <code>YYYYMM</code> <code>202503</code> <code>data_comp_estorno</code> <code>BIGINT</code> Compet\u00eancia de estorno no formato <code>YYYYMM</code> <code>202503</code> <code>max_data_modificacao</code> <code>TIMESTAMP</code> Data da \u00faltima modifica\u00e7\u00e3o do registro (utilizada no incremental) <p>Usar <code>data_comp_*</code> para an\u00e1lises mensais</p> <p>Prefira as colunas <code>data_comp_*</code> (YYYYMM INTEGER) para agrega\u00e7\u00f5es por m\u00eas. Elas s\u00e3o indexadas e permitem filtros como <code>WHERE data_comp_pagamento = 202503</code> sem convers\u00f5es de tipo.</p>","tags":["Marts","Dicion\u00e1rioDeDados","Financeiro","LGPD"]},{"location":"marts/dictionary/#valores-financeiros","title":"Valores Financeiros","text":"Coluna Tipo Descri\u00e7\u00e3o Unidade <code>valor_parcela</code> <code>FLOAT</code> Valor da parcela BRL (R$) <code>valor_tarifario</code> <code>FLOAT</code> Valor tarif\u00e1rio (base de c\u00e1lculo das comiss\u00f5es) BRL (R$) <code>valor_mensal</code> <code>FLOAT</code> Valor mensal do produto BRL (R$) <code>valor_estorno</code> <code>FLOAT</code> Valor estornado (devolvido ao cliente) BRL (R$) <code>per_comissao</code> <code>FLOAT</code> Percentual de comiss\u00e3o do parceiro <code>%</code> (ex: <code>0.30</code> = 30%) <code>comissao_corretor</code> <code>FLOAT</code> Comiss\u00e3o do corretor em R$ BRL (R$) <code>comissao_agencia</code> <code>FLOAT</code> Comiss\u00e3o da ag\u00eancia em R$ BRL (R$) <code>fif</code> <code>INTEGER</code> Parcela gr\u00e1tis: <code>1</code> = gr\u00e1tis (sem cobran\u00e7a ao cliente), <code>0</code> = cobran\u00e7a normal <code>0</code> ou <code>1</code> <p>Aten\u00e7\u00e3o ao <code>valor_estorno</code></p> <p>O <code>valor_estorno</code> aparece em linhas com <code>cd_evento = 301</code>. Para calcular o pr\u00eamio l\u00edquido recebido, subtraia os estornos: <code>SUM(valor_parcela) WHERE cd_evento = 201</code> menos <code>SUM(valor_estorno) WHERE cd_evento = 301</code>.</p>","tags":["Marts","Dicion\u00e1rioDeDados","Financeiro","LGPD"]},{"location":"marts/dictionary/#produto","title":"Produto","text":"Coluna Tipo Descri\u00e7\u00e3o Exemplo <code>cd_produto</code> <code>INTEGER</code> C\u00f3digo num\u00e9rico interno do produto <code>12</code> <code>nm_produto</code> <code>TEXT</code> Nome comercial do produto <code>RD - SEGURO CYBER PICPAY</code> <code>produto_innoveo</code> <code>TEXT</code> Nome t\u00e9cnico do produto na Innoveo <code>picpay_cyber</code> <code>info_productkey</code> <code>TEXT</code> Chave interna de produto na Innoveo <code>picpay_cyber</code> <code>plano</code> <code>TEXT</code> Sub-plano ou cobertura (quando aplic\u00e1vel) <code>CP</code> <code>tipo_produto</code> <code>TEXT</code> Categoria do produto <code>celular</code>, <code>auto</code>, <code>vida</code> <code>insurancetype</code> <code>TEXT</code> Tipo de seguro (campo t\u00e9cnico Innoveo) <code>marca</code> <code>TEXT</code> Marca do aparelho segurado <code>modelo</code> <code>TEXT</code> Modelo do aparelho segurado <code>imei_status</code> <code>TEXT</code> Status do IMEI verificado pela Kakau <code>tipo_seguro</code> <code>TEXT</code> Tipo de cobertura do seguro celular <code>nr_sorte</code> / <code>nr_serie</code> <code>TEXT</code> N\u00famero de sorte/s\u00e9rie (capitaliza\u00e7\u00e3o, quando aplic\u00e1vel)","tags":["Marts","Dicion\u00e1rioDeDados","Financeiro","LGPD"]},{"location":"marts/dictionary/#dados-do-segurado","title":"Dados do Segurado","text":"<p>Dados LGPD \u2014 uso restrito</p> <p>As colunas abaixo cont\u00eam dados pessoais protegidos pela LGPD. Seu uso em relat\u00f3rios externos requer autoriza\u00e7\u00e3o formal do DPO da KOVR. N\u00e3o exponha em dashboards p\u00fablicos ou compartilhe sem anonimiza\u00e7\u00e3o.</p> Coluna Tipo Descri\u00e7\u00e3o <code>nr_cpf</code> <code>TEXT</code> CPF do segurado (11 d\u00edgitos sem formata\u00e7\u00e3o) <code>nome</code> <code>TEXT</code> Nome completo do segurado <code>ddd</code> <code>TEXT</code> DDD do telefone <code>nr_telefone</code> <code>TEXT</code> N\u00famero do telefone <code>cep_zipcode</code> <code>TEXT</code> CEP do endere\u00e7o <code>nm_cidade</code> <code>TEXT</code> Cidade do segurado","tags":["Marts","Dicion\u00e1rioDeDados","Financeiro","LGPD"]},{"location":"marts/dictionary/#outros-campos","title":"Outros Campos","text":"Coluna Tipo Descri\u00e7\u00e3o <code>id_endosso</code> <code>TEXT</code> ID do endosso <code>cd_apolice</code> <code>TEXT</code> C\u00f3digo da ap\u00f3lice <code>motivo_cancelamento</code> <code>TEXT</code> Motivo do cancelamento declarado <code>canal_cancel</code> <code>TEXT</code> Canal pelo qual o cancelamento foi realizado <code>fif</code> <code>INTEGER</code> Parcela gr\u00e1tis: <code>1</code> = gr\u00e1tis (sem cobran\u00e7a ao cliente), <code>0</code> = cobran\u00e7a normal","tags":["Marts","Dicion\u00e1rioDeDados","Financeiro","LGPD"]},{"location":"marts/kpis/","title":"KPIs Financeiros","text":"<p>Defini\u00e7\u00e3o, f\u00f3rmula e orienta\u00e7\u00f5es de uso dos principais indicadores financeiros calculados a partir das tabelas Marts da Innoveo.</p> <p>Pr\u00e9-requisito</p> <p>Todos os KPIs abaixo utilizam as tabelas <code>innoveo_fato_bi</code>, <code>innoveo_financeiro_demais</code> ou <code>innoveo_financeiro_picpay_cyber</code>. Para defini\u00e7\u00e3o de cada coluna, consulte o Dicion\u00e1rio de Dados.</p>","tags":["Financeiro","Marts","Dicion\u00e1rioDeDados"]},{"location":"marts/kpis/#1-premio-emitido","title":"1. Pr\u00eamio Emitido","text":"<p>Defini\u00e7\u00e3o: Soma total do valor de todas as parcelas emitidas \u2014 ou seja, tanto as j\u00e1 pagas quanto as que ainda est\u00e3o a vencer. Representa o tamanho da carteira ativa.</p> \\[ \\text{Pr\u00eamio Emitido} = \\sum \\text{valor\\_parcela} \\quad \\text{onde } cd\\_evento \\in (101, 201) \\] <p>SQL:</p> <pre><code>SELECT\n    data_comp_vencimento,\n    nm_produto,\n    SUM(valor_parcela) AS premio_emitido\nFROM financeiro.innoveo_financeiro_demais\nWHERE cd_evento IN (101, 201)\nGROUP BY 1, 2\nORDER BY 1 DESC;\n</code></pre> <p>N\u00e3o inclua <code>cd_evento = 401</code> no Pr\u00eamio Emitido</p> <p>Parcelas canceladas (<code>cd_evento = 401</code>) n\u00e3o devem compor o pr\u00eamio emitido. Elas representam cobran\u00e7as que foram desfeitas.</p>","tags":["Financeiro","Marts","Dicion\u00e1rioDeDados"]},{"location":"marts/kpis/#2-premio-recebido-arrecadacao","title":"2. Pr\u00eamio Recebido (Arrecada\u00e7\u00e3o)","text":"<p>Defini\u00e7\u00e3o: Soma dos valores efetivamente pagos. Exclui parcelas a vencer, canceladas e estornadas.</p> \\[ \\text{Pr\u00eamio Recebido} = \\sum \\text{valor\\_parcela} \\quad \\text{onde } cd\\_evento = 201 \\] <p>SQL:</p> <pre><code>SELECT\n    data_comp_pagamento,\n    nm_produto,\n    SUM(valor_parcela) AS premio_recebido\nFROM financeiro.innoveo_financeiro_demais\nWHERE cd_evento = 201\n  AND data_comp_pagamento IS NOT NULL\nGROUP BY 1, 2;\n</code></pre>","tags":["Financeiro","Marts","Dicion\u00e1rioDeDados"]},{"location":"marts/kpis/#3-volume-de-estornos","title":"3. Volume de Estornos","text":"<p>Defini\u00e7\u00e3o: Soma dos valores devolvidos ao cliente. Indica inadimpl\u00eancia e cancelamentos com pagamento j\u00e1 realizado.</p> \\[ \\text{Estornos} = \\sum \\text{valor\\_estorno} \\quad \\text{onde } cd\\_evento = 301 \\] <p>SQL:</p> <pre><code>SELECT\n    data_comp_estorno,\n    nm_produto,\n    SUM(valor_estorno)   AS volume_estornado,\n    COUNT(*)             AS qtd_estornos\nFROM financeiro.innoveo_financeiro_demais\nWHERE cd_evento = 301\nGROUP BY 1, 2;\n</code></pre>","tags":["Financeiro","Marts","Dicion\u00e1rioDeDados"]},{"location":"marts/kpis/#4-premio-liquido","title":"4. Pr\u00eamio L\u00edquido","text":"<p>Defini\u00e7\u00e3o: Arrecada\u00e7\u00e3o real ap\u00f3s dedu\u00e7\u00e3o dos estornos.</p> \\[ \\text{Pr\u00eamio L\u00edquido} = \\text{Pr\u00eamio Recebido} - \\text{Volume de Estornos} \\] <p>SQL:</p> <pre><code>SELECT\n    data_comp_vencimento                                        AS competencia,\n    nm_produto,\n    SUM(CASE WHEN cd_evento = 201 THEN valor_parcela   ELSE 0 END)\n        - SUM(CASE WHEN cd_evento = 301 THEN valor_estorno ELSE 0 END)\n        AS premio_liquido\nFROM financeiro.innoveo_financeiro_demais\nGROUP BY 1, 2\nORDER BY 1 DESC;\n</code></pre>","tags":["Financeiro","Marts","Dicion\u00e1rioDeDados"]},{"location":"marts/kpis/#5-taxa-de-cancelamento","title":"5. Taxa de Cancelamento","text":"<p>Defini\u00e7\u00e3o: Percentual de bilhetes cancelados em rela\u00e7\u00e3o ao total de bilhetes emitidos no per\u00edodo.</p> \\[ \\text{Taxa de Cancelamento} = \\frac{\\text{Bilhetes Cancelados}}{\\text{Total de Bilhetes Emitidos}} \\times 100 \\] <p>SQL:</p> <pre><code>SELECT\n    DATE_TRUNC('month', data_inicio)  AS mes_emissao,\n    nm_produto,\n    COUNT(DISTINCT uuid_bilhete)      AS total_bilhetes,\n    COUNT(DISTINCT CASE WHEN status_bilhete = 'cancelled'\n                        THEN uuid_bilhete END)  AS cancelados,\n    ROUND(\n        100.0 * COUNT(DISTINCT CASE WHEN status_bilhete = 'cancelled'\n                                    THEN uuid_bilhete END)\n              / NULLIF(COUNT(DISTINCT uuid_bilhete), 0),\n        2\n    ) AS taxa_cancelamento_pct\nFROM financeiro.innoveo_financeiro_demais\nGROUP BY 1, 2\nORDER BY 1 DESC;\n</code></pre> <p>An\u00e1lise de Churn</p> <p>Combine <code>taxa_cancelamento_pct</code> com o <code>motivo_cancelamento</code> para identificar as principais raz\u00f5es de perda de carteira por produto e parceiro.</p>","tags":["Financeiro","Marts","Dicion\u00e1rioDeDados"]},{"location":"marts/kpis/#6-comissao-corretor","title":"6. Comiss\u00e3o Corretor","text":"<p>Defini\u00e7\u00e3o: Soma da comiss\u00e3o paga ao corretor sobre as parcelas pagas. Base para relat\u00f3rios de repasse financeiro.</p> \\[ \\text{Comiss\u00e3o Corretor} = \\sum \\text{comissao\\_corretor} \\quad \\text{onde } cd\\_evento = 201 \\] <p>SQL:</p> <pre><code>SELECT\n    data_comp_pagamento,\n    nm_produto,\n    SUM(comissao_corretor)  AS total_comissao_corretor,\n    SUM(comissao_agencia)   AS total_comissao_agencia,\n    SUM(per_comissao * valor_parcela) AS comissao_calculada_check\nFROM financeiro.innoveo_financeiro_demais\nWHERE cd_evento = 201\nGROUP BY 1, 2;\n</code></pre>","tags":["Financeiro","Marts","Dicion\u00e1rioDeDados"]},{"location":"marts/kpis/#7-fif-parcelas-gratis","title":"7. FIF \u2014 Parcelas Gr\u00e1tis","text":"<p>Defini\u00e7\u00e3o: Quantidade e valor de parcelas marcadas como gr\u00e1tis (<code>fif = 1</code>), ou seja, sem cobran\u00e7a financeira ao cliente.</p> \\[ \\text{Parcelas FIF} = \\text{COUNT}(*) \\quad \\text{onde } fif = 1 \\] <p>SQL:</p> <pre><code>SELECT\n    DATE_TRUNC('month', data_inicio)  AS mes_emissao,\n    nm_produto,\n    SUM(CASE WHEN fif = 1 THEN 1 ELSE 0 END)           AS bilhetes_fif,\n    COUNT(DISTINCT uuid_bilhete)                         AS total_bilhetes,\n    ROUND(100.0 * SUM(CASE WHEN fif = 1 THEN 1 ELSE 0 END)\n               / NULLIF(COUNT(DISTINCT uuid_bilhete), 0), 2)  AS pct_fif\nFROM financeiro.innoveo_financeiro_demais\nWHERE cd_evento IN (101, 201)\nGROUP BY 1, 2;\n</code></pre> <p>FIF Quote vs FIF Sale</p> <ul> <li><code>info_fif_fifquote</code>: indica parcela gr\u00e1tis no momento da cota\u00e7\u00e3o.</li> <li><code>info_fif_fifsale</code>: indica parcela gr\u00e1tis confirmada na venda.</li> <li>A coluna <code>fif</code> nas Marts representa o <code>fifquote</code>, normalizado para <code>0/1</code> pela macro <code>ajuste_fif</code>.</li> </ul>","tags":["Financeiro","Marts","Dicion\u00e1rioDeDados"]},{"location":"marts/kpis/#8-carteira-ativa-bilhetes-vigentes","title":"8. Carteira Ativa (Bilhetes Vigentes)","text":"<p>Defini\u00e7\u00e3o: Quantidade de bilhetes com status <code>active</code> e com ap\u00f3lice ainda dentro do per\u00edodo de vig\u00eancia.</p> \\[ \\text{Carteira Ativa} = \\text{COUNT(DISTINCT uuid\\_bilhete)} \\quad \\text{onde } status\\_bilhete = \\text{'active'} \\text{ AND } data\\_fim\\_vigencia \\geq \\text{HOJE} \\] <p>SQL:</p> <pre><code>SELECT\n    nm_produto,\n    COUNT(DISTINCT uuid_bilhete) AS carteira_ativa\nFROM financeiro.innoveo_financeiro_demais\nWHERE status_bilhete = 'active'\n  AND data_fim_vigencia &gt;= CURRENT_DATE\nGROUP BY 1\nORDER BY 2 DESC;\n</code></pre>","tags":["Financeiro","Marts","Dicion\u00e1rioDeDados"]},{"location":"marts/kpis/#9-competencia-vs-data-de-pagamento","title":"9. Compet\u00eancia vs. Data de Pagamento","text":"<p>Aten\u00e7\u00e3o \u2014 compet\u00eancia de an\u00e1lise</p> <p>Existem diferen\u00e7as importantes entre filtrar por data de vencimento e data de pagamento:</p> Filtro Quando usar <code>data_comp_vencimento</code> Relat\u00f3rios de emiss\u00e3o e carteira a receber <code>data_comp_pagamento</code> Relat\u00f3rios de caixa e arrecada\u00e7\u00e3o efetiva <code>data_comp_estorno</code> An\u00e1lise de devolu\u00e7\u00f5es e inadimpl\u00eancia <p>Exemplo: Uma parcela com vencimento em janeiro (<code>data_comp_vencimento = 202501</code>) pode ter sido paga em mar\u00e7o (<code>data_comp_pagamento = 202503</code>). Para o relat\u00f3rio de caixa de mar\u00e7o, use <code>data_comp_pagamento = 202503</code>.</p>","tags":["Financeiro","Marts","Dicion\u00e1rioDeDados"]},{"location":"marts/kpis/#resumo-dos-kpis","title":"Resumo dos KPIs","text":"KPI <code>cd_evento</code> Coluna principal Agrupamento sugerido Pr\u00eamio Emitido <code>IN (101, 201)</code> <code>valor_parcela</code> Produto, compet\u00eancia vencimento Pr\u00eamio Recebido <code>= 201</code> <code>valor_parcela</code> Produto, compet\u00eancia pagamento Volume de Estornos <code>= 301</code> <code>valor_estorno</code> Produto, compet\u00eancia estorno Pr\u00eamio L\u00edquido <code>201 - 301</code> <code>valor_parcela - valor_estorno</code> Produto, m\u00eas Taxa de Cancelamento Todos <code>uuid_bilhete</code> Produto, m\u00eas emiss\u00e3o Comiss\u00e3o Corretor <code>= 201</code> <code>comissao_corretor</code> Produto, compet\u00eancia pagamento Bilhetes com FIF <code>IN (101, 201)</code> <code>fif</code> Produto, m\u00eas emiss\u00e3o Carteira Ativa <code>active</code> <code>uuid_bilhete</code> Produto","tags":["Financeiro","Marts","Dicion\u00e1rioDeDados"]},{"location":"parceiros/","title":"Parceiros \u2014 Vis\u00e3o Geral","text":"<p>O pipeline cobre 9 parceiros com 22 produtos de seguro distribu\u00eddos. Esta p\u00e1gina consolida as informa\u00e7\u00f5es de cobertura e mapeamento t\u00e9cnico de cada um.</p>","tags":["Financeiro","Staging"]},{"location":"parceiros/#mapa-de-parceiros","title":"Mapa de Parceiros","text":"Parceiro Produtos Source Name Staging Models Intermediate PicPay 8 <code>picpay</code> 16 8 WillBank 2 <code>willbank</code> 4 2 SemParar 4 <code>semparar</code> 6 4 KOVR B2C 3 <code>KOVR</code> 6 3 Disney 1 <code>KOVR</code> 2 1 Natura 1 <code>natura</code> 2 1 XP 1 <code>XP</code> 2 1 Metlife 1 <code>KOVR</code> 2 1 Banco Fitness 1 <code>KOVR</code> 2 1 Total 22 6 grupos 42 22","tags":["Financeiro","Staging"]},{"location":"parceiros/#picpay","title":"PicPay","text":"<p>O maior parceiro do portf\u00f3lio, com 8 produtos cobrindo as principais linhas de seguro massificado.</p> Produto Staging (infos + parcelas) Intermediate Notas Cyber <code>stg_picpay_cyber_*</code> <code>int_picpay_cyber</code> Phone <code>stg_picpay_phone_*</code> <code>int_picpay_phone</code> Inclui dados de IMEI e aparelho Residencial <code>stg_picpay_residencial_*</code> <code>int_picpay_residencial</code> Auto <code>stg_picpay_auto_*</code> <code>int_picpay_auto</code> Inclui dados de ve\u00edculo Sa\u00fade <code>stg_picpay_saude_*</code> <code>int_picpay_saude</code> Empr\u00e9stimo <code>stg_picpay_emprestimo_*</code> <code>int_picpay_emprestimo</code> Prestamista Vida Individual <code>stg_picpay_vida_individual_*</code> <code>int_picpay_vida_individual</code> Fatura <code>stg_picpay_fatura_*</code> <code>int_picpay_fatura</code> Seguro de fatura de cart\u00e3o <p>PicPay Cyber \u2014 tabela dedicada</p> <p>Por volume e especificidade, o PicPay Cyber possui uma tabela Mart pr\u00f3pria: <code>innoveo_financeiro_picpay_cyber</code>. Os demais produtos do PicPay est\u00e3o em <code>innoveo_financeiro_demais</code>.</p> <p>Campos exclusivos PicPay Cyber:</p> Campo Tabela Descri\u00e7\u00e3o <code>info_picpaycertificate_cpf</code> infos CPF do titular do certificado <code>info_picpay_coveragecode</code> infos C\u00f3digo de cobertura PicPay <code>info_picpay_comissionfee</code> infos Taxa de comiss\u00e3o <code>info_capitalization_lucknumber*</code> infos N\u00fameros da sorte (capitaliza\u00e7\u00e3o) <code>transactionid</code> parcelas ID da transa\u00e7\u00e3o","tags":["Financeiro","Staging"]},{"location":"parceiros/#willbank","title":"WillBank","text":"Produto Staging Intermediate Notas Carteira <code>stg_willbank_carteira_*</code> <code>int_willbank_carteira</code> Cobertura de carteira financeira Celular <code>stg_willbank_celular_*</code> <code>int_willbank_celular</code> Inclui dados de aparelho <p>Campos exclusivos WillBank:</p> Campo Descri\u00e7\u00e3o <code>info_valoraparelho</code> Valor declarado do aparelho segurado <code>info_modelid</code> ID do modelo do aparelho <code>info_apisauxiliares_kakau_brand/model</code> Marca/modelo verificado pela Kakau <code>info_apisauxiliares_kakau_imeistatus</code> Status do IMEI na base Kakau","tags":["Financeiro","Staging"]},{"location":"parceiros/#semparar","title":"SemParar","text":"Produto Staging Intermediate Notas Auto <code>stg_semparar_auto_*</code> <code>int_semparar_auto</code> Seguro de ve\u00edculo com dados FIPE Auto Di\u00e1rio <code>stg_semparar_autodiario_*</code> <code>int_semparar_autodiario</code> Seguro por dia / di\u00e1ria Viagem <code>stg_semparar_viagem_infos</code> <code>int_semparar_viagem</code> Apenas infos (sem tabela de parcelas separada) Prestamista <code>stg_semparar_prestamista_infos</code> <code>int_semparar_prestamista</code> Cr\u00e9dito com cobertura <p>SemParar Viagem e Prestamista</p> <p>Os produtos Viagem e Prestamista do SemParar possuem apenas tabela de <code>infos</code> nas sources \u2014 sem tabela de <code>parcelas</code> separada. As informa\u00e7\u00f5es financeiras est\u00e3o embutidas na tabela <code>infos</code>.</p> <p>Campos exclusivos SemParar:</p> Campo Descri\u00e7\u00e3o <code>info_riskdata_fipe</code> C\u00f3digo FIPE do ve\u00edculo <code>info_riskdata_licenceplate</code> Placa do ve\u00edculo <code>info_riskdata_chassi</code> Chassi do ve\u00edculo <code>info_riskdata_renavam</code> RENAVAM do ve\u00edculo <code>info_tipocompra</code> Tipo de aquisi\u00e7\u00e3o do seguro <code>info_fif_semparar</code> FIF espec\u00edfico SemParar","tags":["Financeiro","Staging"]},{"location":"parceiros/#kovr-b2c","title":"KOVR B2C","text":"<p>Produtos comercializados diretamente pela KOVR sem intermedia\u00e7\u00e3o banc\u00e1ria.</p> Produto Staging Intermediate AP (Acidentes Pessoais) <code>stg_kovr_ap_*</code> <code>int_kovr_ap</code> Phone <code>stg_kovr_phone_*</code> <code>int_kovr_phone</code> Vida <code>stg_kovr_vida_*</code> <code>int_kovr_vida</code>","tags":["Financeiro","Staging"]},{"location":"parceiros/#disney","title":"Disney","text":"Produto Staging Intermediate AP (Acidentes Pessoais) <code>stg_disney_ap_*</code> <code>int_disney_ap</code> <p>Source group</p> <p>Disney AP est\u00e1 agrupado no source group <code>KOVR</code> junto com os produtos KOVR B2C.</p>","tags":["Financeiro","Staging"]},{"location":"parceiros/#natura","title":"Natura","text":"Produto Staging Intermediate Residencial <code>stg_natura_residencial_*</code> <code>int_natura_residencial</code>","tags":["Financeiro","Staging"]},{"location":"parceiros/#xp","title":"XP","text":"Produto Staging Intermediate Cart\u00e3o <code>stg_xp_card_*</code> <code>int_xp_card</code>","tags":["Financeiro","Staging"]},{"location":"parceiros/#metlife","title":"Metlife","text":"Produto Staging Intermediate Celular <code>stg_metlife_celular_*</code> <code>int_metlife_celular</code>","tags":["Financeiro","Staging"]},{"location":"parceiros/#banco-fitness","title":"Banco Fitness","text":"Produto Staging Intermediate Seguro <code>stg_banco_fitness_*</code> <code>int_banco_fitness</code>","tags":["Financeiro","Staging"]},{"location":"parceiros/#distribuicao-no-mart","title":"Distribui\u00e7\u00e3o no Mart","text":"<pre><code>pie title Modelos Intermediate por Parceiro\n    \"PicPay\" : 8\n    \"WillBank\" : 2\n    \"SemParar\" : 4\n    \"KOVR B2C\" : 3\n    \"Disney\" : 1\n    \"Natura\" : 1\n    \"XP\" : 1\n    \"Metlife\" : 1\n    \"Banco Fitness\" : 1</code></pre>","tags":["Financeiro","Staging"]}]}